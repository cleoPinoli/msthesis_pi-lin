\begin{code}[hide]%
\>[0]\AgdaSymbol{\{-\#}\AgdaSpace{}%
\AgdaKeyword{OPTIONS}\AgdaSpace{}%
\AgdaPragma{--rewriting}\AgdaSpace{}%
\AgdaSymbol{\#-\}}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Fin}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Binary.PropositionalEquality}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaDatatype{\AgdaUnderscore{}‚â°\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{cong‚ÇÇ}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Agda.Builtin.Equality.Rewrite}\<%
\end{code}

\subsection{Type Representation}
\label{sec:type-agda}

The representation of types is standard, with one constructor for each of the
forms described in \Cref{sec:calculus}. We start by defining \emph{pre-types} as
an indexed data type $\AgdaDatatype{PreType}~n$ where $n$ is the number of bound
type variables and we use de Bruijn indices for denoting type variables. In this
way, we make sure that pre-types are well-scoped.

\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{‚ä§}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüò}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä•}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüô}%
\>[19]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
%
\>[2]\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{rav}%
\>[19]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
%
\>[2]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}\&\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚äï\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚Öã\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚äó\AgdaUnderscore{}}}%
\>[19]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
%
\>[2]\AgdaInductiveConstructor{`‚àÄ}\AgdaSpace{}%
\AgdaInductiveConstructor{`‚àÉ}%
\>[19]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
%
\>[2]\AgdaInductiveConstructor{`!}\AgdaSpace{}%
\AgdaInductiveConstructor{`?}%
\>[19]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\<%
\end{code}

Note the constructors \AgdaInductiveConstructor{var} and
\AgdaInductiveConstructor{rav}, which respectively represent type variables and
their dual, and the quantifiers \AgdaInductiveConstructor{`‚àÄ} and
\AgdaInductiveConstructor{`‚àÉ} which increase the number of bound type variables
in the scoped (pre)type.

The dual of a (pre)type is computed by the following function:

\begin{code}%
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä§}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüò}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüò}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä§}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä•}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüô}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüô}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä•}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{rav}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{rav}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\&}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äï}}\AgdaSpace{}%
\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äï}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\&}}\AgdaSpace{}%
\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚Öã}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äó}}\AgdaSpace{}%
\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äó}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚Öã}}\AgdaSpace{}%
\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`‚àÄ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`‚àÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`‚àÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}%
\>[14]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`‚àÄ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`!}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}%
\>[15]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`?}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`?}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}%
\>[15]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`!}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\end{code}

It is straightforward to prove that duality is a an involution.

\begin{code}%
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚â°}}\AgdaSpace{}%
\AgdaBound{A}\<%
\end{code}
\begin{code}[hide]%
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{‚ä§}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ùüò}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{‚ä•}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ùüô}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{rav}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\&}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}\&\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaFunction{dual-inv}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äï}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚äï\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaFunction{dual-inv}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚Öã}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚Öã\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaFunction{dual-inv}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äó}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚äó\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaFunction{dual-inv}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{`‚àÄ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{`‚àÄ}\AgdaSpace{}%
\AgdaFunction{dual-inv}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{`‚àÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{`‚àÉ}\AgdaSpace{}%
\AgdaFunction{dual-inv}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{`!}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{`!}\AgdaSpace{}%
\AgdaFunction{dual-inv}\<%
\\
\>[0]\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{`?}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{`?}\AgdaSpace{}%
\AgdaFunction{dual-inv}\<%
\end{code}

This property is so important in the rest of the formalization that it is worth
defining an implicit rewriting rule so that Agda can autonomously apply it
whenever possible. This is achieved by means of the following pragma
directive.\footnote{The directive is effective provided that the option
\texttt{--rewriting} is enabled, either globally when invoking Agda or in the
module's preamble.}

\begin{code}%
\>[0]\AgdaSymbol{\{-\#}\AgdaSpace{}%
\AgdaKeyword{REWRITE}\AgdaSpace{}%
\AgdaFunction{dual-inv}\AgdaSpace{}%
\AgdaSymbol{\#-\}}\<%
\end{code}

\begin{code}[hide]%
\>[0]\AgdaFunction{ext}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
\>[0]\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä§}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä§}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüò}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüò}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä•}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä•}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüô}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüô}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{rav}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{rav}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\&}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\&}}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äï}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äï}}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚Öã}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚Öã}}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äó}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äó}}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`‚àÄ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`‚àÄ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`‚àÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`‚àÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{ext}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`!}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`!}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`?}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`?}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{rename}\AgdaSpace{}%
\AgdaBound{œÅ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaFunction{exts}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\\
\>[0]\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{rename}\AgdaSpace{}%
\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\<%
\end{code}

Next we define the function \AgdaFunction{subst} that simultaneously substitutes
the type variables of a (pre)type with other (pre)types. Even though in practice
we will always substitute one variable at a time, it is technically easier to
substitutes \emph{all} variables of a (pre)type. The definition of
\AgdaFunction{subst} relies on some auxiliary functions for \emph{renaming} type
variables and \emph{lifting} substitutions across quantifiers. All such
definitions are straightforward adaptations of those described by
\cite{KokkeSiekWadler20}.

\begin{code}%
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\<%
\end{code}
\begin{code}[hide]%
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä§}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä§}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüò}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüò}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä•}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{‚ä•}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüô}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{ùüô}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{rav}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\&}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\&}}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äï}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äï}}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚Öã}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚Öã}}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äó}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äó}}\AgdaSpace{}%
\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{B}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`‚àÄ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`‚àÄ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`‚àÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`‚àÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`!}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`!}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{`?}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{`?}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\end{code}

Among all substitutions, we will use the one that substitutes the 0-indexed type
variable with a (pre)type. It is convenient to introduce this substitution once
and for all, which we do here.

\begin{code}%
\>[0]\AgdaOperator{\AgdaFunction{[\AgdaUnderscore{}/]}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\<%
\\
\>[0]\AgdaOperator{\AgdaFunction{[}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{/]}}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}%
\>[16]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
\>[0]\AgdaOperator{\AgdaFunction{[}}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{/]}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{suc}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}%
\>[16]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{k}\<%
\end{code}

Duality and substitutions are meant to commute.

\begin{code}%
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[582I]\AgdaSymbol{‚àÄ\{}\AgdaBound{m}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Fin}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{n}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\<%
\\
\>[.][@{}l@{}]\<[582I]%
\>[13]\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚â°}}\AgdaSpace{}%
\AgdaFunction{dual}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{subst}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}\<%
\end{code}
\begin{code}[hide]%
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{‚ä§}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ùüò}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{‚ä•}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{ùüô}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}

It is worth discussing one case in the proof of \AgdaFunction{dual-subst}:
\begin{code}%
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{rav}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}

Here we are supposed to prove
$\AgdaFunction{subst}~\sigma~(\AgdaFunction{dual}~(\AgdaInductiveConstructor{rav}~x))
  \equiv
  \AgdaFunction{dual}~(\AgdaFunction{subst}~\sigma~(\AgdaInductiveConstructor{rav}~x))$
  which is definitionally the same of $\sigma~x \equiv
  \AgdaFunction{dual}~(\AgdaFunction{dual}~(\sigma~x))$.
%
We could easily prove this equivalence by invoking \AgdaFunction{dual-inv}, but
thanks to the added rewriting rule a use of \AgdaInductiveConstructor{refl}
suffices. In this case the saved effort is negligible, but in later results,
where it is necessary to use \AgdaFunction{dual-inv} for rewriting part of the
\emph{index} of some type families, having an implicit rewriting rule allows us
to avoid writing some quite obscure Agda code.

\begin{code}[hide]%
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\&}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚äï\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{B}\AgdaSymbol{\})}\<%
\\
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äï}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}\&\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{B}\AgdaSymbol{\})}\<%
\\
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚Öã}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚äó\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{B}\AgdaSymbol{\})}\<%
\\
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚äó}}\AgdaSpace{}%
\AgdaBound{B}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚Öã\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{B}\AgdaSymbol{\})}\<%
\\
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{`‚àÄ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{`‚àÉ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\})}\<%
\\
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{`‚àÉ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{`‚àÄ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{exts}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\})}\<%
\\
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{`!}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{`?}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\})}\<%
\\
\>[0]\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{`?}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{cong}\AgdaSpace{}%
\AgdaInductiveConstructor{`!}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{œÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œÉ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{A}\AgdaSymbol{\})}\<%
\end{code}

Just like \AgdaFunction{dual-inv}, \AgdaFunction{dual-subst} too is key in the
formalization that follows. Therefore, we add it to the set of implicit
rewriting rules used by Agda so that we do not have to think about it again.

\begin{code}%
\>[0]\AgdaSymbol{\{-\#}\AgdaSpace{}%
\AgdaKeyword{REWRITE}\AgdaSpace{}%
\AgdaFunction{dual-subst}\AgdaSpace{}%
\AgdaSymbol{\#-\}}\<%
\end{code}

At last we are ready to define the type of closed pre-types, those
having no free type variables. We call \AgdaDatatype{Type} closed pre-types.
From now on, we will seldom use pre-types again.

\begin{code}%
\>[0]\AgdaFunction{Type}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
\>[0]\AgdaFunction{Type}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{PreType}\AgdaSpace{}%
\AgdaInductiveConstructor{zero}\<%
\end{code}
