
rec tps : (Œ®:ctx) (Œî:[Œ® ‚ä¢ lctx N[]]) [Œ® ‚ä¢ P ‚áõ P'] ‚Üí [Œ® ‚ä¢ oft P Œî] ‚Üí [Œ® ‚ä¢ oft P' Œî] =
  / total 1 /
  fn rd, d ‚áí case rd of
  % Principal cut reductions
  | [_ ‚ä¢ Œ≤fwd] ‚áí
    let [_ ‚ä¢ oft/pcomp DU[] M1 (\x.oft/fwd DU'[] (upd/n U1') U2 E1) (\x.O2)] = d in
    let Prune-Upd [_ ‚ä¢ U1] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
    let [_,x:obj ‚ä¢ upd-istop _] = upd_var_istop [_,x:obj ‚ä¢ U2] in
    let [ ‚ä¢ refl] = dual_uniq [ ‚ä¢ DU] [ ‚ä¢ DU'] in
    let [_ ‚ä¢ merge-upd2 U1a U1b ‚Ä¢/10 M2 _ _ _] = merge_upd_cor2 [_ ‚ä¢ U1] [_ ‚ä¢ M1] [ ‚ä¢ ‚Ä¢/00] in
    let [_ ‚ä¢ cx/refl] = upd_refl2 [_ ‚ä¢ U1a] in
    let [_,x:obj ‚ä¢ exh/c E2 _] = [_ ‚ä¢ E1] in
    let [_ ‚ä¢ cx/refl] = merge_id [_ ‚ä¢ M2] (prune_exh [_,x:obj ‚ä¢ E2]) in
    oft_rename [_,x:obj ‚ä¢ O2] (upd_symm [_ ‚ä¢ U1b])
  | [_ ‚ä¢ Œ≤1‚ä•] ‚áí
    let [_ ‚ä¢ oft/pcomp D1 M (\x.oft/close U1 E) (\x.oft/wait U2 O2)] = d in
    (case [_,x:obj ‚ä¢ U1] of
    | [_,x:obj ‚ä¢ upd/t _] ‚áí
      let [_,x:obj ‚ä¢ exh/c E1 _] = [_,y:obj ‚ä¢ E] in
      let [_ ‚ä¢ cx/refl] = merge_id [_ ‚ä¢ M] (prune_exh [_ ‚ä¢ E1]) in
      (case [_,x:obj ‚ä¢ U2] of
      | [_,x:obj ‚ä¢ upd/t _] ‚áí
        let [_,x:obj ‚ä¢ O2'] = (oft_str [_,x:obj ‚ä¢ O2]) in
        let Prune-Oft [_ ‚ä¢ O1] [_,x:obj ‚ä¢ _] = prune_oft [_,x:obj ‚ä¢ O2'] in
        [_ ‚ä¢ O1]
      | [_,x:obj ‚ä¢ upd/n U2] ‚áí impossible upd_contra [_,x:obj ‚ä¢ U2]
      )
    | [_,x:obj ‚ä¢ upd/n U1] ‚áí
      let [_,x:obj ‚ä¢ exh/c _ T[]] = [_,x:obj ‚ä¢ E] in
      impossible [ ‚ä¢ T]
    )
  | [_ ‚ä¢ Œ≤‚äó‚Öã] ‚áí
    let [_ ‚ä¢ oft/pcomp (D‚äó DU1[] DU2[]) M1 (\x.oft/out U1 (mg/c M2' MLT1[]) (\y.O1) (\y.O2)) (\x.oft/inp U2 \y.\z.O3)] = d in
    let Prune-Merge [_ ‚ä¢ M2] [_,x:obj ‚ä¢ _] = prune_merge [_,x:obj ‚ä¢ M2'] in
    let [_,x:obj ‚ä¢ upd-istop _] = upd_var_istop [_,x:obj ‚ä¢ U1] in
    let [_,x:obj ‚ä¢ upd-istop _] = upd_var_istop [_,x:obj ‚ä¢ U2] in
    let [ ‚ä¢ ‚Ä¢/01] = [ ‚ä¢ MLT1] in
    let [_ ‚ä¢ mg-assoc M3 M _ _] = merge_assoc [_ ‚ä¢ M1] [_ ‚ä¢ M2] in
    % Typing judgments
    let [ ‚ä¢ _]:[ ‚ä¢ dual A A'] = [ ‚ä¢ DU1] in
    let [_,x:obj ‚ä¢ O1'] = oft_str_cor [_,x:obj,y:obj ‚ä¢ O1] in
    let [_,x:obj ‚ä¢ O2''] = oft_str_cor [_,x:obj,y:obj ‚ä¢ O2] in
    let [_,x:obj,y:obj ‚ä¢ O2'[..,y,x]] = oft_exch_top (oft_weak [_,x:obj,y:obj ‚ä¢ O2''[..,x]] [_,x:obj,y:obj ‚ä¢ y] [ ‚ä¢ A']) in
    let [_,x:obj,y:obj,z:obj ‚ä¢ O3''] = oft_exch_top (oft_str (oft_exch_top2 [_,y:obj,z:obj,x:obj ‚ä¢ O3[..,x,y,z]])) in
    let Prune-Oft [_,x:obj,y:obj ‚ä¢ O3'[..,y,x]] [_,x:obj,y:obj,z:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj,z:obj ‚ä¢ O3''] in
    [_ ‚ä¢ oft/pcomp DU1[] M (\x.O1') (\x.oft/pcomp DU2[] (mg/c M3[..] ‚Ä¢/01) (\y.O2') (\y.O3'))]
  | [_ ‚ä¢ Œ≤‚äï&1] ‚áí
    let [_ ‚ä¢ oft/pcomp (D‚äï DU1[] _) M1 (\x.oft/inl U1 (\z.O1)) (\x.oft/choice U2 (\y.O2) (\y.O3))] = d in
    let [_,x:obj ‚ä¢ upd-istop _] = upd_var_istop [_,x:obj ‚ä¢ U1] in
    let [_,x:obj ‚ä¢ upd-istop _] = upd_var_istop [_,x:obj ‚ä¢ U2] in
    let [_,x:obj ‚ä¢ O1'] = oft_str_cor [_,x:obj,y:obj ‚ä¢ O1] in
    let [_,x:obj ‚ä¢ O2'] = oft_str_cor [_,x:obj,y:obj ‚ä¢ O2] in
    [_ ‚ä¢ oft/pcomp DU1[] M1 (\x.O1') (\x.O2')]
  | [_ ‚ä¢ Œ≤‚äï&2] ‚áí
    let [_ ‚ä¢ oft/pcomp (D‚äï _ DU2[]) M1 (\x.oft/inr U1 (\z.O1)) (\x.oft/choice U2 (\y.O2) (\y.O3))] = d in
    let [_,x:obj ‚ä¢ upd-istop _] = upd_var_istop [_,x:obj ‚ä¢ U1] in
    let [_,x:obj ‚ä¢ upd-istop _] = upd_var_istop [_,x:obj ‚ä¢ U2] in
    let [_,x:obj ‚ä¢ O1'] = oft_str_cor [_,x:obj,y:obj ‚ä¢ O1] in
    let [_,x:obj ‚ä¢ O3'] = oft_str_cor [_,x:obj,y:obj ‚ä¢ O3] in
    [_ ‚ä¢ oft/pcomp DU2[] M1 (\x.O1') (\x.O3')]
  % Commuting conversions
  | [_ ‚ä¢ Œ∫‚ä•] ‚áí
    let [_ ‚ä¢ oft/pcomp DU[] M1 (\x.oft/wait (upd/n U1') O1) (\x.O2)] = d in
    let Prune-Upd [_ ‚ä¢ U1] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
    let [_ ‚ä¢ merge-upd2 U2 U ‚Ä¢/10 M2 _ _ _] = merge_upd_cor2 [_ ‚ä¢ U1] [_ ‚ä¢ M1] [ ‚ä¢ ‚Ä¢/00] in
    let [_ ‚ä¢ cx/refl] = upd_refl2 [_ ‚ä¢ U2] in
    [_ ‚ä¢ oft/wait U (oft/pcomp DU[] M2 (\x.O1) (\x.O2))]
  | [_ ‚ä¢ Œ∫‚äó1] ‚áí
    let [_ ‚ä¢ oft/pcomp DU[] M1 (\x.oft/out (upd/n U1') (mg/c M2' MLT[]) (\y.O1) (\y.O2)) (\y.O3)] = d in
    let Prune-Merge [_ ‚ä¢ M2] [_,x:obj ‚ä¢ _] = prune_merge [_,x:obj ‚ä¢ M2'] in
    let Prune-Upd [_ ‚ä¢ U1] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
    (case [ ‚ä¢ MLT] of
    | [ ‚ä¢ ‚Ä¢/10] ‚áí
      let [_ ‚ä¢ M2_comm] = merge_comm [_ ‚ä¢ M2] in
      let [_ ‚ä¢ mg-assoc M3 M_comm _ _] = merge_assoc [_ ‚ä¢ M1] [_ ‚ä¢ M2_comm] in
      let [_ ‚ä¢ M] = merge_comm [_ ‚ä¢ M_comm] in
      % Typing judgments
      let [_ ‚ä¢ _]:[_ ‚ä¢ upd _ _ _ _ (B1[] ‚äó _) _ _ _ _] = [_ ‚ä¢ U1] in
      let [_,x:obj,y:obj ‚ä¢ O1'[..,y,x]] = oft_exch_top [_,x:obj,y:obj ‚ä¢ O1] in
      let [_,x:obj ‚ä¢ O2'] = oft_str_cor [_,x:obj,y:obj ‚ä¢ O2] in
      let [_,x:obj,y:obj ‚ä¢ O3'] = oft_exch_top (oft_weak [_,x:obj,y:obj ‚ä¢ O3[..,y]] [_,x:obj,y:obj ‚ä¢ x] [ ‚ä¢ B1]) in
      % Conclusion
      [_ ‚ä¢ oft/out U1 M (\x.oft/pcomp DU[] (mg/c M3[..] ‚Ä¢/10) (\y.O1') (\y.O3')) (\x.O2')]
    | [ ‚ä¢ ‚Ä¢/01] ‚áí
      let [_,x:obj,y:obj ‚ä¢ _]:[_,x:obj,y:obj ‚ä¢ oft _ (cons (cons Œî‚ÇÇ'[..] _ A[] _) _ _ _)] = [_,x:obj,y:obj ‚ä¢ O2] in
      let [_,x:obj ‚ä¢ LK] = refl_top [_,x:obj ‚ä¢ Œî‚ÇÇ'[..]] [_,x:obj ‚ä¢ x] [ ‚ä¢ A] [ ‚ä¢ ùüô] in
      let [_,x:obj,y:obj ‚ä¢ INP] = oft_lin_in [_,x:obj,y:obj ‚ä¢ O2] [_,x:obj,y:obj ‚ä¢ upd/n LK[..,x]] in
      impossible in_proc_lemma [_,x:obj,y:obj ‚ä¢ INP[..,y,x]]
    )
  | [_ ‚ä¢ Œ∫‚äó2] ‚áí
    let [_ ‚ä¢ oft/pcomp DU[] M1 (\x.oft/out (upd/n U1') (mg/c M2' MLT[]) (\y.O1) (\y.O2)) (\x.O3)] = d in
    let Prune-Merge [_ ‚ä¢ M2] [_,x:obj ‚ä¢ _] = prune_merge [_,x:obj ‚ä¢ M2'] in
    let Prune-Upd [_ ‚ä¢ U1] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
    (case [ ‚ä¢ MLT] of
    | [ ‚ä¢ ‚Ä¢/10] ‚áí
      let [_,x:obj,y:obj ‚ä¢ _]:[_,x:obj,y:obj ‚ä¢ oft _ (cons (cons Œî‚ÇÅ[..] _ A[] _) _ _ _)] = [_,x:obj,y:obj ‚ä¢ O1] in
      let [_,x:obj ‚ä¢ LK] = refl_top [_,x:obj ‚ä¢ Œî‚ÇÅ[..]] [_,x:obj ‚ä¢ x] [ ‚ä¢ A] [ ‚ä¢ ùüô] in
      let [_,x:obj,y:obj ‚ä¢ INP] = oft_lin_in [_,x:obj,y:obj ‚ä¢ O1] [_,x:obj,y:obj ‚ä¢ upd/n LK[..,x]] in
      impossible in_proc_lemma [_,x:obj,y:obj ‚ä¢ INP[..,y,x]]
    | [ ‚ä¢ ‚Ä¢/01] ‚áí
      let [_ ‚ä¢ mg-assoc M3 M _ _] = merge_assoc [_ ‚ä¢ M1] [_ ‚ä¢ M2] in
      let [_ ‚ä¢ merge-upd2 U2 U3 ‚Ä¢/10 M3' _ _ _] = merge_upd_cor2 [_ ‚ä¢ U1] [_ ‚ä¢ M3] [ ‚ä¢ ‚Ä¢/00] in
      let [_ ‚ä¢ cx/refl] = upd_refl2 [_ ‚ä¢ U2] in
      % Typing judgments
      let [_ ‚ä¢ _]:[_ ‚ä¢ upd _ _ _ _ (_ ‚äó B2[]) _ _ _ _] = [_ ‚ä¢ U1] in
      let [_,x:obj ‚ä¢ O1'] = oft_str_cor [_,x:obj,y:obj ‚ä¢ O1] in
      let [_,x:obj,y:obj ‚ä¢ O2'[..,y,x]] = oft_exch_top [_,x:obj,y:obj ‚ä¢ O2] in
      let [_,x:obj,y:obj ‚ä¢ O3'] = oft_exch_top (oft_weak [_,x:obj,y:obj ‚ä¢ O3[..,y]] [_,x:obj,y:obj ‚ä¢ x] [ ‚ä¢ B2]) in
      % Conclusion
      [_ ‚ä¢ oft/out U3 M (\x.O1') (\x.oft/pcomp DU[] (mg/c M3'[..] ‚Ä¢/10) (\y.O2') (\y.O3'))]
    )
  | [_ ‚ä¢ Œ∫‚Öã] ‚áí
    let [_ ‚ä¢ oft/pcomp DU[] M1 (\x.oft/inp (upd/n U1') \y.\z.O1) (\x.O2)] = d in
    let Prune-Upd [_ ‚ä¢ U1] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
    let [_ ‚ä¢ merge-upd2 U2 U ‚Ä¢/10 M2 _ _ _] = merge_upd_cor2 [_ ‚ä¢ U1] [_ ‚ä¢ M1] [ ‚ä¢ ‚Ä¢/00] in
    let [_ ‚ä¢ cx/refl] = upd_refl2 [_ ‚ä¢ U2] in
    % O1, O2
    let [_,x:obj,y:obj,z:obj ‚ä¢ O1']:[_,x:obj,y:obj,z:obj ‚ä¢ oft _ (cons (cons (cons _ _ B2[] _) _ B1[] _) _ _ _)] =
      oft_exch_top2 [_,y:obj,z:obj,x:obj ‚ä¢ O1[..,x,y,z]] in
    let [_,x:obj,y:obj ‚ä¢ O2'] = oft_exch_top (oft_weak [_,x:obj,y:obj ‚ä¢ O2[..,y]] [_,x:obj,y:obj ‚ä¢ x] [ ‚ä¢ B2]) in
    let [_,x:obj,y:obj,z:obj ‚ä¢ O2''[..,y,x,z]] = oft_exch_top (oft_weak [_,x:obj,y:obj,z:obj ‚ä¢ O2'[..,y,z]] [_,x:obj,y:obj,z:obj ‚ä¢ x] [ ‚ä¢ B1]) in
    [_ ‚ä¢ oft/inp U \x.\y.oft/pcomp DU[] (mg/c (mg/c M2[..] ‚Ä¢/10) ‚Ä¢/10) (\z.O1') (\z.O2'')]
  | [_ ‚ä¢ Œ∫‚äï1] ‚áí
    let [_ ‚ä¢ oft/pcomp DU[] M1 (\x.oft/inl (upd/n U1') \y.O1) (\x.O2)] = d in
    let Prune-Upd [_ ‚ä¢ U1] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
    let [_ ‚ä¢ _]:[_ ‚ä¢ upd _ _ _ _ (B1[] ‚äï _) _ _ _ _] = [_ ‚ä¢ U1] in
    let [_ ‚ä¢ merge-upd2 U2 U ‚Ä¢/10 M2 _ _ _] = merge_upd_cor2 [_ ‚ä¢ U1] [_ ‚ä¢ M1] [ ‚ä¢ ‚Ä¢/00] in
    let [_ ‚ä¢ cx/refl] = upd_refl2 [_ ‚ä¢ U2] in
    % Typing judgments
    let [_,x:obj,y:obj ‚ä¢ O1'[..,y,x]] = oft_exch_top [_,x:obj,y:obj ‚ä¢ O1] in
    let [_,x:obj,y:obj ‚ä¢ O2'] = oft_exch_top (oft_weak [_,x:obj,y:obj ‚ä¢ O2[..,y]] [_,x:obj,y:obj ‚ä¢ x] [ ‚ä¢ B1]) in
    % Conclusion
    [_ ‚ä¢ oft/inl U \x.oft/pcomp DU[] (mg/c M2[..] ‚Ä¢/10) (\y.O1') (\y.O2')]
  | [_ ‚ä¢ Œ∫‚äï2] ‚áí
    let [_ ‚ä¢ oft/pcomp DU[] M1 (\x.oft/inr (upd/n U1') \y.O1) (\x.O2)] = d in
    let Prune-Upd [_ ‚ä¢ U1] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
    let [_ ‚ä¢ _]:[_ ‚ä¢ upd _ _ _ _ (_ ‚äï B2[]) _ _ _ _] = [_ ‚ä¢ U1] in
    let [_ ‚ä¢ merge-upd2 U2 U ‚Ä¢/10 M2 _ _ _] = merge_upd_cor2 [_ ‚ä¢ U1] [_ ‚ä¢ M1] [ ‚ä¢ ‚Ä¢/00] in
    let [_ ‚ä¢ cx/refl] = upd_refl2 [_ ‚ä¢ U2] in
    % Typing judgments
    let [_,x:obj,y:obj ‚ä¢ O1'[..,y,x]] = oft_exch_top [_,x:obj,y:obj ‚ä¢ O1] in
    let [_,x:obj,y:obj ‚ä¢ O2'] = oft_exch_top (oft_weak [_,x:obj,y:obj ‚ä¢ O2[..,y]] [_,x:obj,y:obj ‚ä¢ x] [ ‚ä¢ B2]) in
    % Conclusion
    [_ ‚ä¢ oft/inr U \x.oft/pcomp DU[] (mg/c M2[..] ‚Ä¢/10) (\y.O1') (\y.O2')]
  | [_ ‚ä¢ Œ∫&] ‚áí
    let [_ ‚ä¢ oft/pcomp DU[] M1 (\x.oft/choice (upd/n U1') (\y.O1) (\y.O2)) (\x.O3)] = d in
    % Get `update` and `merge` judgments
    let Prune-Upd [_ ‚ä¢ U1] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
    let [_ ‚ä¢ _]:[_ ‚ä¢ upd _ _ _ _ (B1[] & B2[]) _ _ _ _] = [_ ‚ä¢ U1] in
    let [_ ‚ä¢ merge-upd2 U2 U ‚Ä¢/10 M2 _ _ _] = merge_upd_cor2 [_ ‚ä¢ U1] [_ ‚ä¢ M1] [ ‚ä¢ ‚Ä¢/00] in
    let [_ ‚ä¢ cx/refl] = upd_refl2 [_ ‚ä¢ U2] in
    % Typing judgments
    let [_,x:obj,y:obj ‚ä¢ O1_sw[..,y,x]] = oft_exch_top [_,x:obj,y:obj ‚ä¢ O1] in
    let [_,x:obj,y:obj ‚ä¢ O2_sw[..,y,x]] = oft_exch_top [_,x:obj,y:obj ‚ä¢ O2] in
    let [_,x:obj,y:obj ‚ä¢ O3a] = oft_exch_top (oft_weak [_,x:obj,y:obj ‚ä¢ O3[..,y]] [_,x:obj,y:obj ‚ä¢ x] [ ‚ä¢ B1]) in
    let [_,x:obj,y:obj ‚ä¢ O3b] = oft_exch_top (oft_weak [_,x:obj,y:obj ‚ä¢ O3[..,y]] [_,x:obj,y:obj ‚ä¢ x] [ ‚ä¢ B2]) in
    % Conclusion
    [_ ‚ä¢ oft/choice U (\x.oft/pcomp DU[] (mg/c M2[..] ‚Ä¢/10) (\y.O1_sw) (\y.O3a)) (\x.oft/pcomp DU[] (mg/c M2[..] ‚Ä¢/10) (\y.O2_sw) (\y.O3b))]
  % Reduction under cut
  | [_ ‚ä¢ Œ≤‚à•1 \x.RD1] ‚áí
    let [_ ‚ä¢ oft/pcomp DU[] M (\x.O1') (\x.O2)] = d in
    let [_,x:obj ‚ä¢ O1] = tps [_,x:obj ‚ä¢ RD1] [_,x:obj ‚ä¢ O1'] in
    [_ ‚ä¢ oft/pcomp DU[] M (\x.O1) (\x.O2)]
  | [_ ‚ä¢ Œ≤‚à•2 \x.RD1] ‚áí
    let [_ ‚ä¢ oft/pcomp DU[] M (\x.O1) (\x.O2')] = d in
    let [_,x:obj ‚ä¢ O2] = tps [_,x:obj ‚ä¢ RD1] [_,x:obj ‚ä¢ O2'] in
    [_ ‚ä¢ oft/pcomp DU[] M (\x.O1) (\x.O2)]
  % Reductions commute with equivalences
  | [_ ‚ä¢ Œ≤‚â° CG1 RD1 CG2] ‚áí oft_cong (tps [_ ‚ä¢ RD1] (oft_cong d [_ ‚ä¢ CG1])) [_ ‚ä¢ CG2]
  ;

