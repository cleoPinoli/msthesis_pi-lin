rec relus_to_encctx : RelUsed [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] ‚Üí Enc [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] =
  / total 1 /
  fn ru ‚áí case ru of
  | relUsed/n ‚áí Enc/n
  | relUsed/c ru1 ‚áí Enc/c (relus_to_encctx ru1) [ ‚ä¢ _] [ ‚ä¢ _]
  ;

rec relnm_to_encctx : RelName [Œ® ‚ä¢ _] [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] ‚Üí Enc [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] =
  / total 1 /
  fn rn ‚áí case rn of
  | relName/t ru ‚áí Enc/c (relus_to_encctx ru) [ ‚ä¢ _] [ ‚ä¢ _]
  | relName/n rn ‚áí Enc/c (relnm_to_encctx rn) [ ‚ä¢ _] [ ‚ä¢ _]
  ;

rec encctx_merge : Enc [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] ‚Üí [Œ® ‚ä¢ merge Œî‚ÇÅ Œî‚ÇÇ Œî] ‚Üí Enc [Œ® ‚ä¢ Œî‚ÇÅ] $[Œ¶ ‚ä¢ $œÉ] =
  / total 1 /
  fn ec, m ‚áí case m of
  | [_ ‚ä¢ mg/n] ‚áí ec
  | [_ ‚ä¢ mg/c M1 _] ‚áí
    let Enc/c ec1 [ ‚ä¢ _] [ ‚ä¢ _] = ec in
    let Prune-Merge [_ ‚ä¢ M1'] [_,x:obj ‚ä¢ _] = prune_merge [_,x:obj ‚ä¢ M1] in
    Enc/c (encctx_merge ec1 [_ ‚ä¢ M1']) [ ‚ä¢ _] [ ‚ä¢ _]
  ;

rec encctx_merge_l : Enc [Œ® ‚ä¢ Œî‚ÇÅ] $[Œ¶ ‚ä¢ $œÉ] ‚Üí [Œ® ‚ä¢ merge Œî‚ÇÅ Œî‚ÇÇ Œî] ‚Üí Enc [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] =
  / total 1 /
  fn ec, m ‚áí case m of
  | [_ ‚ä¢ mg/n] ‚áí ec
  | [_ ‚ä¢ mg/c M1 _] ‚áí
    let Enc/c ec1 [ ‚ä¢ _] [ ‚ä¢ _] = ec in
    let Prune-Merge [_ ‚ä¢ M1'] [_,x:obj ‚ä¢ _] = prune_merge_l [_,x:obj ‚ä¢ M1] in
    Enc/c (encctx_merge_l ec1 [_ ‚ä¢ M1']) [ ‚ä¢ _] [ ‚ä¢ _]
  ;

rec encctx_upd : Enc [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] ‚Üí [Œ® ‚ä¢ upd Œî _ X X A[] A[] _ _ Œî'] ‚Üí Enc [Œ® ‚ä¢ Œî'] $[Œ¶ ‚ä¢ $œÉ] =
  / total 1 /
  fn e, u ‚áí case u of
  | [_ ‚ä¢ upd/t _] ‚áí
    let Enc/c ec1 [ ‚ä¢ _] [ ‚ä¢ _] = e in
    Enc/c ec1 [ ‚ä¢ _] [ ‚ä¢ _]
  | [_ ‚ä¢ upd/n U1] ‚áí
    let Enc/c ec1 [ ‚ä¢ _] [ ‚ä¢ _] = e in
    let Prune-Upd [_ ‚ä¢ U1'] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1] in
    Enc/c (encctx_upd ec1 [_ ‚ä¢ U1']) [ ‚ä¢ _] [ ‚ä¢ _]
  ;

rec lookup_to_hyp : Enc [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] ‚Üí [Œ® ‚ä¢ upd Œî _ X X' A[] A' Œ± Œ±' Œî'] ‚Üí [Œ¶ ‚ä¢ hyp X[$œÉ] A[]] =
  / total 1 /
  fn e, u ‚áí case u of
  | [_ ‚ä¢ upd/t _] ‚áí let Enc/c ec1 [ ‚ä¢ _] [ ‚ä¢ _] = e in [_,b:block x:obj,h:hyp _ _ ‚ä¢ b.2]
  | [_ ‚ä¢ upd/n U1] ‚áí
    let Enc/c ec1 [ ‚ä¢ _] [ ‚ä¢ _] = e in
    let [_,x:obj ‚ä¢ U1'] = upd_refl [_,x:obj ‚ä¢ U1] in
    let Prune-Upd [_ ‚ä¢ U1''] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
    let [_ ‚ä¢ hx] = lookup_to_hyp ec1 [_ ‚ä¢ U1''] in
    [_,b:block x:obj,h:hyp _ _ ‚ä¢ hx[..]]
  ;

rec exh_to_relus : Enc [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] ‚Üí [Œ® ‚ä¢ exh Œî] ‚Üí RelUsed [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] =
  / total 1 /
  fn ec, e ‚áí case e of
  | [_ ‚ä¢ exh/n] ‚áí let Enc/n = ec in relUsed/n
  | [_ ‚ä¢ exh/c E1 hal/0] ‚áí
    let Enc/c ec1 [ ‚ä¢ _] [ ‚ä¢ _] = ec in
    relUsed/c (exh_to_relus ec1 (prune_exh [_,x:obj ‚ä¢ E1]))
  ;

rec unqlin_to_relnm : Enc [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] ‚Üí [Œ® ‚ä¢ upd Œî _ X X A[] A[] ùüô ùüò Œî'] ‚Üí [Œ® ‚ä¢ exh Œî'] ‚Üí RelName [Œ® ‚ä¢ X] [Œ® ‚ä¢ Œî] $[Œ¶ ‚ä¢ $œÉ] =
  / total 1 /
  fn ec, u, e ‚áí case u of
  | [_ ‚ä¢ upd/t _] ‚áí
    let Enc/c ec1 [ ‚ä¢ _] [ ‚ä¢ _] = ec in
    let [_,x:obj ‚ä¢ exh/c E1 hal/0] = e in
    relName/t (exh_to_relus ec1 (prune_exh [_,x:obj ‚ä¢ E1]))
  | [_ ‚ä¢ upd/n U1] ‚áí
    let Enc/c ec1 [ ‚ä¢ _] [ ‚ä¢ _] = ec in
    let [_,x:obj ‚ä¢ exh/c E1 hal/0] = e in
    let Prune-Upd [_ ‚ä¢ U1'] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1] in
    relName/n (unqlin_to_relnm ec1 [_ ‚ä¢ U1'] (prune_exh [_,x:obj ‚ä¢ E1]))
  ;


rec oft_linear : (Œ®:ctx) (Œî:[Œ® ‚ä¢ lctx N[]]) [Œ®,x:obj ‚ä¢ oft P (cons Œî[..] x A[] ùüô)] ‚Üí [Œ® ‚ä¢ linear \x.P] =
  / total d (oft_linear d) /
  fn d1 ‚áí case d1 of
  | [_,x:obj ‚ä¢ oft/fwd _ U1 U2 E] ‚áí
    (case [_,x:obj ‚ä¢ U1] of
    | [_,x:obj ‚ä¢ upd/t _] ‚áí
      let [_,x:obj ‚ä¢ upd/n U2'] = [_,x:obj ‚ä¢ U2] in
      let Prune-Upd [_ ‚ä¢ _] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U2'] in
      [_ ‚ä¢ l_fwd2]
    | [_,x:obj ‚ä¢ upd/n U1'] ‚áí
      let Prune-Upd [_ ‚ä¢ _] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
      (case [_,x:obj ‚ä¢ U2] of
      | [_,x:obj ‚ä¢ upd/t _] ‚áí [_ ‚ä¢ l_fwd1]
      | [_,x:obj ‚ä¢ upd/n _] ‚áí
        let [_,x:obj ‚ä¢ exh/c _ T[]] = [_,x:obj ‚ä¢ E] in
        impossible [ ‚ä¢ T]
      )
    )
  | [_,x:obj ‚ä¢ oft/close U1 E] ‚áí
    (case [_,x:obj ‚ä¢ U1] of
    | [_,x:obj ‚ä¢ upd/t _] ‚áí [_ ‚ä¢ l_close]
    | [_,x:obj ‚ä¢ upd/n _] ‚áí
      let [_,x:obj ‚ä¢ exh/c _ T[]] = [_,x:obj ‚ä¢ E] in
      impossible [ ‚ä¢ T]
    )
  | [_,x:obj ‚ä¢ oft/wait U1 O1] ‚áí
    (case [_,x:obj ‚ä¢ U1] of
    | [_,x:obj ‚ä¢ upd/t _] ‚áí
      let [_,x:obj ‚ä¢ O2'] = oft_str [_,x:obj ‚ä¢ O1] in
      let Prune-Oft [_ ‚ä¢ O2] [_,x:obj ‚ä¢ _] = prune_oft [_,x:obj ‚ä¢ O2'] in
      [_ ‚ä¢ l_wait]
    | [_,x:obj ‚ä¢ upd/n U1'] ‚áí
      let Prune-Upd [_ ‚ä¢ _] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
      let [_ ‚ä¢ LN] = oft_linear [_,x:obj ‚ä¢ O1] in
      [_ ‚ä¢ l_wait2 LN]
    )
  | [_,x:obj ‚ä¢ oft/out U1 (mg/c M1 MLT[]) (\y.O1) (\y.O2)] ‚áí
    let Prune-Merge [_ ‚ä¢ M2] [_,x:obj ‚ä¢ _] = prune_merge [_,x:obj ‚ä¢ M1] in
    (case [_,x:obj ‚ä¢ U1] of
    | [_,x:obj ‚ä¢ upd/t _] ‚áí
      let [ ‚ä¢ ‚Ä¢/01] = [ ‚ä¢ MLT] in
      let [_,x:obj,y:obj ‚ä¢ O1'] = oft_str (oft_exch_top [_,x:obj,y:obj ‚ä¢ O1[..,y,x]]) in
      let [_,x:obj,y:obj ‚ä¢ O2'] = oft_str (oft_exch_top [_,x:obj,y:obj ‚ä¢ O2[..,y,x]]) in
      let Prune-Oft [_,x:obj ‚ä¢ _] [_,x:obj,y:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj ‚ä¢ O1'] in
      let Prune-Oft [_,x:obj ‚ä¢ O2''] [_,x:obj,y:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj ‚ä¢ O2'] in
      let [_ ‚ä¢ LN2] = oft_linear [_,x:obj ‚ä¢ O2''] in
      [_ ‚ä¢ l_out LN2]
    | [_,x:obj ‚ä¢ upd/n U1'] ‚áí
      let Prune-Upd [_ ‚ä¢ _] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
      (case [ ‚ä¢ MLT] of
      | [ ‚ä¢ ‚Ä¢/10] ‚áí
        let [_,x:obj ‚ä¢ LN] = oft_linear (oft_exch_top [_,x:obj,y:obj ‚ä¢ O1[..,y,x]]) in
        let [_,x:obj,y:obj ‚ä¢ O2'] = oft_str (oft_exch_top [_,x:obj,y:obj ‚ä¢ O2[..,y,x]]) in
        let Prune-Oft [_,x:obj ‚ä¢ _] [_,x:obj,y:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj ‚ä¢ O2'] in
        [_ ‚ä¢ l_out2 \x.LN]
      | [ ‚ä¢ ‚Ä¢/01] ‚áí
        let [_,x:obj,y:obj ‚ä¢ O1'] = oft_str (oft_exch_top [_,x:obj,y:obj ‚ä¢ O1[..,y,x]]) in
        let Prune-Oft [_,x:obj ‚ä¢ _] [_,x:obj,y:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj ‚ä¢ O1'] in
        let [_,x:obj ‚ä¢ LN] = oft_linear (oft_exch_top [_,x:obj,y:obj ‚ä¢ O2[..,y,x]]) in
        [_ ‚ä¢ l_out3 \x.LN]
      )
    )
  | [_,x:obj ‚ä¢ oft/inp U1 \y.\z.O1] ‚áí
    (case [_,x:obj ‚ä¢ U1] of
    | [_,x:obj ‚ä¢ upd/t _] ‚áí
      let [_,x:obj,y:obj,z:obj ‚ä¢ O2'] = oft_str (oft_exch_top2 [_,y:obj,z:obj,x:obj ‚ä¢ O1[..,x,y,z]]) in
      let Prune-Oft [_,x:obj,y:obj ‚ä¢ O2] [_,x:obj,y:obj,z:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj,z:obj ‚ä¢ O2'] in
      let [_,x:obj ‚ä¢ LN] = oft_linear (oft_exch_top [_,x:obj,y:obj ‚ä¢ O2[..,y,x]]) in
      [_ ‚ä¢ l_inp \x.LN]
    | [_,x:obj ‚ä¢ upd/n U1'] ‚áí
      let Prune-Upd [_ ‚ä¢ _] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
      let [_,x:obj,y:obj ‚ä¢ LN] = oft_linear (oft_exch_top2 [_,y:obj,z:obj,x:obj ‚ä¢ O1[..,x,y,z]]) in
      [_ ‚ä¢ l_inp2 \x.\y.LN]
    )
  | [_,x:obj ‚ä¢ oft/pcomp DU[] (mg/c M1 MLT[]) (\y.O1) (\y.O2)] ‚áí
    let Prune-Merge [_ ‚ä¢ M2] [_,x:obj ‚ä¢ _] = prune_merge [_,x:obj ‚ä¢ M1] in
    (case [ ‚ä¢ MLT] of
    | [ ‚ä¢ ‚Ä¢/10] ‚áí
      let [_,x:obj ‚ä¢ LN1] = oft_linear (oft_exch_top [_,x:obj,y:obj ‚ä¢ O1[..,y,x]]) in
      let [_,x:obj,y:obj ‚ä¢ O2'] = oft_str (oft_exch_top [_,x:obj,y:obj ‚ä¢ O2[..,y,x]]) in
      let Prune-Oft [_,x:obj ‚ä¢ _] [_,x:obj,y:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj ‚ä¢ O2'] in
      [_ ‚ä¢ l_pcomp1 \x.LN1]
    | [ ‚ä¢ ‚Ä¢/01] ‚áí
      let [_,x:obj,y:obj ‚ä¢ O1'] = oft_str (oft_exch_top [_,x:obj,y:obj ‚ä¢ O1[..,y,x]]) in
      let Prune-Oft [_,x:obj ‚ä¢ _] [_,x:obj,y:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj ‚ä¢ O1'] in
      let [_,x:obj ‚ä¢ LN1] = oft_linear (oft_exch_top [_,x:obj,y:obj ‚ä¢ O2[..,y,x]]) in
      [_ ‚ä¢ l_pcomp2 \x.LN1]
    )
  | [_,x:obj ‚ä¢ oft/inl U1 \y.O1] ‚áí
    (case [_,x:obj ‚ä¢ U1] of
    | [_,x:obj ‚ä¢ upd/t _] ‚áí
      let [_,x:obj,y:obj ‚ä¢ O2'] = oft_str (oft_exch_top [_,x:obj,y:obj ‚ä¢ O1[..,y,x]]) in
      let Prune-Oft [_,x:obj ‚ä¢ O2] [_,x:obj,y:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj ‚ä¢ O2'] in
      let [_ ‚ä¢ LN] = oft_linear [_,x:obj ‚ä¢ O2] in
      [_ ‚ä¢ l_inl LN]
    | [_,x:obj ‚ä¢ upd/n U1'] ‚áí
      let Prune-Upd [_ ‚ä¢ _] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
      let [_,x:obj ‚ä¢ LN] = oft_linear (oft_exch_top [_,x:obj,y:obj ‚ä¢ O1[..,y,x]]) in
      [_ ‚ä¢ l_inl2 \x.LN]
    )
  | [_,x:obj ‚ä¢ oft/inr U1 \y.O1] ‚áí
    (case [_,x:obj ‚ä¢ U1] of
    | [_,x:obj ‚ä¢ upd/t _] ‚áí
      let [_,x:obj,y:obj ‚ä¢ O2'] = oft_str (oft_exch_top [_,x:obj,y:obj ‚ä¢ O1[..,y,x]]) in
      let Prune-Oft [_,x:obj ‚ä¢ O2] [_,x:obj,y:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj ‚ä¢ O2'] in
      let [_ ‚ä¢ LN] = oft_linear [_,x:obj ‚ä¢ O2] in
      [_ ‚ä¢ l_inr LN]
    | [_,x:obj ‚ä¢ upd/n U1'] ‚áí
      let Prune-Upd [_ ‚ä¢ _] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
      let [_,x:obj ‚ä¢ LN] = oft_linear (oft_exch_top [_,x:obj,y:obj ‚ä¢ O1[..,y,x]]) in
      [_ ‚ä¢ l_inr2 \x.LN]
    )
  | [_,x:obj ‚ä¢ oft/choice U1 (\y.O1) (\y.O2)] ‚áí
    (case [_,x:obj ‚ä¢ U1] of
    | [_,x:obj ‚ä¢ upd/t _] ‚áí
      let [_,x:obj,y:obj ‚ä¢ O1'] = oft_str (oft_exch_top [_,x:obj,y:obj ‚ä¢ O1[..,y,x]]) in
      let [_,x:obj,y:obj ‚ä¢ O2'] = oft_str (oft_exch_top [_,x:obj,y:obj ‚ä¢ O2[..,y,x]]) in
      let Prune-Oft [_,x:obj ‚ä¢ O1''] [_,x:obj,y:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj ‚ä¢ O1'] in
      let Prune-Oft [_,x:obj ‚ä¢ O2''] [_,x:obj,y:obj ‚ä¢ _] = prune_oft [_,x:obj,y:obj ‚ä¢ O2'] in
      let [_ ‚ä¢ LN1] = oft_linear [_,x:obj ‚ä¢ O1''] in
      let [_ ‚ä¢ LN2] = oft_linear [_,x:obj ‚ä¢ O2''] in
      [_ ‚ä¢ l_choice LN1 LN2]
    | [_,x:obj ‚ä¢ upd/n U1'] ‚áí
      let Prune-Upd [_ ‚ä¢ _] [_,x:obj ‚ä¢ _] = prune_upd [_,x:obj ‚ä¢ U1'] in
      let [_,x:obj ‚ä¢ LN1] = oft_linear (oft_exch_top [_,x:obj,y:obj ‚ä¢ O1[..,y,x]]) in
      let [_,x:obj ‚ä¢ LN2] = oft_linear (oft_exch_top [_,x:obj,y:obj ‚ä¢ O2[..,y,x]]) in
      [_ ‚ä¢ l_choice2 (\x.LN1) (\x.LN2)]
    )
  ;
