\subsection{Type Safety}
\label{sec:safety-agda}

\begin{code}[hide]%
\>[0]\AgdaSymbol{\{-\#}\AgdaSpace{}%
\AgdaKeyword{OPTIONS}\AgdaSpace{}%
\AgdaPragma{--rewriting}\AgdaSpace{}%
\AgdaSymbol{\#-\}}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List.Base}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{[]}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚à∑\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{[\AgdaUnderscore{}]}}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Type}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Context}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Process}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Congruence}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{DeadlockFreedom}\<%
\end{code}

We have seen that type safety is a simple instance of deadlock freedom, which is
made even simpler to formalize in our development where processes are
intrinsically typed. We start by defining reduction contexts as processes with a
single hole. In our intrinsically-typed formalization, reduction contexts are
typed and indexed by two typing contexts $\ContextD$ and $\ContextC$. The latter
is the typing context under which the reduction context as a whole is well
typed. The former is the typing context of the hole, which is invariant for a
given reduction context and therefore specified as a parameter of the data type:

\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Œî}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Context}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Context}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{hole}%
\>[9]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{Œî}\<%
\\
%
\>[2]\AgdaInductiveConstructor{cut-l}%
\>[9]\AgdaSymbol{:}%
\>[31I]\AgdaSymbol{‚àÄ\{}\AgdaBound{Œì}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÅ}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÇ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Œì}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚âÉ}}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{+}}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÇ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\<%
\\
\>[.][@{}l@{}]\<[31I]%
\>[11]\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚à∑}}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Process}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚à∑}}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÇ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\<%
\\
%
\>[11]\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{Œì}\<%
\\
%
\>[2]\AgdaInductiveConstructor{cut-r}%
\>[9]\AgdaSymbol{:}%
\>[56I]\AgdaSymbol{‚àÄ\{}\AgdaBound{Œì}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÅ}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÇ}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Œì}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚âÉ}}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{+}}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÇ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\<%
\\
\>[.][@{}l@{}]\<[56I]%
\>[11]\AgdaDatatype{Process}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚à∑}}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚à∑}}\AgdaSpace{}%
\AgdaBound{Œì‚ÇÇ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\<%
\\
%
\>[11]\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{Œì}\<%
\end{code}

Substitution inside a reduction context $\ReductionContext$ is a straightforward
function $\AgdaFunction{\_‚ü¶\_‚üß}$ that operates recursively on the structure of
$\ReductionContext$:

\begin{code}%
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}‚ü¶\AgdaUnderscore{}‚üß}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{Œì}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{Œì}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Process}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Process}\AgdaSpace{}%
\AgdaBound{Œì}\<%
\\
\>[0]\AgdaInductiveConstructor{hole}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}%
\>[19]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{P}\<%
\\
\>[0]\AgdaInductiveConstructor{cut-l}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{ùíû}\AgdaSpace{}%
\AgdaBound{Q}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}%
\>[19]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{cut}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ùíû}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{Q}\<%
\\
\>[0]\AgdaInductiveConstructor{cut-r}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{Q}\AgdaSpace{}%
\AgdaBound{ùíû}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}%
\>[19]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{cut}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaBound{Q}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ùíû}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}\AgdaSymbol{)}\<%
\end{code}

A process $P$ is well formed if every unguarded sub-process $Q$ in it is alive.

\begin{code}%
\>[0]\AgdaFunction{WellFormed}%
\>[18]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{Œì}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Process}\AgdaSpace{}%
\AgdaBound{Œì}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
\>[0]\AgdaFunction{WellFormed}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Œì}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{P}%
\>[18]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{Œî}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{ùíû}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{Œì}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Q}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Process}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\<%
\\
\>[18][@{}l@{\AgdaIndent{0}}]%
\>[19]\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚äí}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ùíû}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{Q}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{Alive}\AgdaSpace{}%
\AgdaBound{Q}\<%
\end{code}

The proof of type safety ends up being a trivial application of
\AgdaFunction{deadlock-freedom}.

\begin{code}%
\>[0]\AgdaFunction{type-safety}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{Œì}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{P}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Process}\AgdaSpace{}%
\AgdaBound{Œì}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{WellFormed}\AgdaSpace{}%
\AgdaBound{P}\<%
\\
\>[0]\AgdaFunction{type-safety}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Q}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{deadlock-freedom}\AgdaSpace{}%
\AgdaBound{Q}\<%
\end{code}