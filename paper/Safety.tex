\subsection{Type Safety}
\label{sec:safety-agda}

\begin{code}[hide]%
\>[0]\AgdaSymbol{\{-\#}\AgdaSpace{}%
\AgdaKeyword{OPTIONS}\AgdaSpace{}%
\AgdaPragma{--rewriting}\AgdaSpace{}%
\AgdaSymbol{\#-\}}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List.Base}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{[]}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚à∑\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{[\AgdaUnderscore{}]}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Unary}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Type}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Context}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Process}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Congruence}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{DeadlockFreedom}\<%
\end{code}

We have seen that type safety is a simple instance of deadlock freedom, which is
made even simpler to formalise in our development where processes are
intrinsically typed. We start by defining reduction contexts as processes with a
single hole. In our intrinsically-typed formalisation, reduction contexts are
parameterised by the typing context $\ContextD$ of the hole, which is invariant,
and indexed by the typing context $\ContextC$ of the whole reduction context:

\begin{code}%
\>[0]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Œî}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Context}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Context}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaInductiveConstructor{hole}%
\>[9]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{Œî}\<%
\\
%
\>[2]\AgdaInductiveConstructor{cut-l}%
\>[9]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{‚àÄ[}%
\>[22]\AgdaSymbol{((}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚à∑\AgdaUnderscore{}}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ä¢}}\AgdaSpace{}%
\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚àó}}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚à∑\AgdaUnderscore{}}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ä¢}}\AgdaSpace{}%
\AgdaDatatype{Proc}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚áí}}\<%
\\
%
\>[22]\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaFunction{]}\<%
\\
%
\>[2]\AgdaInductiveConstructor{cut-r}%
\>[9]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{A}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{‚àÄ[}%
\>[22]\AgdaSymbol{((}\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚à∑\AgdaUnderscore{}}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ä¢}}\AgdaSpace{}%
\AgdaDatatype{Proc}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚àó}}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaFunction{dual}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚à∑\AgdaUnderscore{}}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ä¢}}\AgdaSpace{}%
\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚áí}}\<%
\\
%
\>[22]\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaFunction{]}\<%
\end{code}

Note the presence of two constructors \AgdaInductiveConstructor{cut-l} and
\AgdaInductiveConstructor{cut-r} which distinguish on whether the hole is found
in the left (respectively, right) sub-context, as per the grammar of reduction
contexts in \Cref{sec:properties}.

Substitution inside a reduction context $\ReductionContext$ is a straightforward
function $\AgdaFunction{\_‚ü¶\_‚üß}$ that operates recursively on the structure of
$\ReductionContext$:

\begin{code}%
\>[0]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}‚ü¶\AgdaUnderscore{}‚üß}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{Œì}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{Œì}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Proc}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Proc}\AgdaSpace{}%
\AgdaBound{Œì}\<%
\\
\>[0]\AgdaInductiveConstructor{hole}%
\>[19]\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{P}\<%
\\
\>[0]\AgdaInductiveConstructor{cut-l}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ùíû}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü®}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü©}}\AgdaSpace{}%
\AgdaBound{Q}\AgdaSymbol{)}%
\>[19]\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{cut}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaBound{ùíû}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü®}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü©}}\AgdaSpace{}%
\AgdaBound{Q}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaInductiveConstructor{cut-r}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Q}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü®}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü©}}\AgdaSpace{}%
\AgdaBound{ùíû}\AgdaSymbol{)}%
\>[19]\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{cut}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Q}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü®}}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü©}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ùíû}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}\AgdaSymbol{))}\<%
\end{code}

A process $P$ is well formed if every unguarded sub-process $Q$ in it is alive.

\begin{code}%
\>[0]\AgdaFunction{WellFormed}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{Œì}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Proc}\AgdaSpace{}%
\AgdaBound{Œì}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
\>[0]\AgdaFunction{WellFormed}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Œì}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaSymbol{=}%
\>[126I]\AgdaSymbol{‚àÄ\{}\AgdaBound{Œî}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{ùíû}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ReductionContext}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{Œì}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Q}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Proc}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\<%
\\
\>[.][@{}l@{}]\<[126I]%
\>[19]\AgdaBound{P}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚äí}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ùíû}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ü¶}}\AgdaSpace{}%
\AgdaBound{Q}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚üß}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{Alive}\AgdaSpace{}%
\AgdaBound{Q}\<%
\end{code}

The proof of type safety ends up being a trivial application of
\AgdaFunction{deadlock-freedom}, since the process $Q$ in the hole of a
reduction context is well typed by construction.

\begin{code}%
\>[0]\AgdaFunction{type-safety}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚àÄ\{}\AgdaBound{Œì}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{P}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Proc}\AgdaSpace{}%
\AgdaBound{Œì}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{WellFormed}\AgdaSpace{}%
\AgdaBound{P}\<%
\\
\>[0]\AgdaFunction{type-safety}\AgdaSpace{}%
\AgdaBound{P}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Q}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{deadlock-freedom}\AgdaSpace{}%
\AgdaBound{Q}\<%
\end{code}